name: CI Pipeline (Bazel targets)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  actions: write

jobs:
  build-test-run-record:
    name: Build, Test, Run & Record
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install system dependencies (lz4/zstd, pip)
        run: |
          sudo apt-get update
          sudo apt-get install -y libzstd-dev liblz4-dev python3-pip

      - name: Set up Bazel (with caches)
        uses: bazel-contrib/setup-bazel@0.15.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}
          repository-cache: true

      - name: Build host + plugin
        run: |
          bazelisk build //host:main //plugin:libfake_plugin_so.so
          echo "✅ build host+plugin"

      - name: Build proto (do teu alvo proto)
        run: |
          bazelisk build //proto:demo_cc_proto
          echo "✅ build proto"

      - name: Build recorder tool
        run: |
          bazelisk build //record_tool:record_mcap
          echo "✅ build record_tool:record_mcap"


      - name: Plugin unit tests
        run: |
          bazelisk test //plugin:fake_plugin_test --test_output=errors
          echo "✅ plugin tests"

      - name: All tests (equivalente a test-all)
        run: |
          bazelisk test //... --test_output=errors
          echo "✅ all tests"

      - name: Smoke: run host with plugin
        run: |
          bazelisk run //host:main -- $(bazelisk info bazel-bin)/plugin/libfake_plugin_so.so
          echo "✅ host run with plugin"

   

  multi-platform:
    name: Multi-platform smoke
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-20.04]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libzstd-dev liblz4-dev

      - name: Set up Bazel (with caches)
        uses: bazel-contrib/setup-bazel@0.15.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}
          repository-cache: true

      - name: Build host + plugin (targets explícitos)
        run: |
          bazelisk build //host:main //plugin:libfake_plugin_so.so
          echo "✅ build ${{ matrix.os }}"

      - name: Quick plugin test  
        run: |
          bazelisk test //plugin:fake_plugin_test --test_output=errors
          echo "✅ tests ${{ matrix.os }}"
