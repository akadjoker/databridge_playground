name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ "**" ]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: System libs (zstd/lz4)
        run: |
          sudo apt-get update
          sudo apt-get install -y libzstd-dev liblz4-dev

      - name: Setup Bazelisk
        uses: bazelbuild/setup-bazelisk@v2

      - name: Build host & plugin
        run: |
          bazel build \
            //host:main \
            //plugin:libfake_plugin_so.so \
            --verbose_failures

      - name: Test (if any)
        shell: bash
        run: |
          set -e
          TESTS="$(bazel query "kind('.*_test', //...)" || true)"
          if [ -z "$TESTS" ]; then
            echo "No test targets found. Skipping bazel test."
          else
            echo "Running tests:"
            echo "$TESTS"
            bazel test $TESTS --test_output=errors --verbose_failures
          fi

