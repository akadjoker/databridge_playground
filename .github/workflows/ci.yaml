name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ "**" ]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-depth: 0

      - name: System libs (zstd/lz4)
        run: |
          sudo apt-get update
          sudo apt-get install -y libzstd-dev liblz4-dev

      - name: Install Bazelisk (no cache workaround)
        run: |
          BZLISK_VERSION=1.27.0
          curl -sSL -o bazelisk "https://github.com/bazelbuild/bazelisk/releases/download/v${BZLISK_VERSION}/bazelisk-linux-amd64"
          sudo install -m 0755 bazelisk /usr/local/bin/bazel
          bazel version

      - name: Build host & plugin
        run: |
          bazel build \
            //host:main \
            //plugin:libfake_plugin_so.so \
            --verbose_failures

      - name: Test (auto-discover)
        shell: bash
        run: |
          set -e
          TESTS="$(bazel query "kind('.*_test', //...)" || true)"
          if [ -z "$TESTS" ]; then
            echo "No test targets found. Skipping bazel test."
          else
            echo "Running tests:"
            echo "$TESTS"
            bazel test $TESTS --test_output=errors --verbose_failures
          fi

